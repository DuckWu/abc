
import sys
import re
from elasticsearch import Elasticsearch

CLOUD_ID = ""
API_KEY = ""
HOSTS = ["http://localhost:9200"]
USE_CLOUD = False
USE_API_KEY = True
USERNAME = "elastic"
PASSWORD = ""
DRY_RUN = True

REGEX = re.compile(r"^(?P<prefix>.+)_(?P<date>\d{8})_(?P<serial>\d+)$")

def make_client():
    if USE_CLOUD:
        if USE_API_KEY:
            return Elasticsearch(cloud_id=CLOUD_ID, api_key=API_KEY, request_timeout=60)
        return Elasticsearch(cloud_id=CLOUD_ID, basic_auth=(USERNAME, PASSWORD), request_timeout=60)
    else:
        if USERNAME:
            return Elasticsearch(hosts=HOSTS, basic_auth=(USERNAME, PASSWORD), request_timeout=60)
        return Elasticsearch(hosts=HOSTS, request_timeout=60)

def parse_index(name):
    m = REGEX.match(name)
    if not m:
        return None, None, None
    return m.group("prefix"), int(m.group("date")), int(m.group("serial"))

def cleanup_alias(es, alias):
    indices_aliases = es.indices.get_alias(index=f"{alias}_*", name=alias, ignore_unavailable=True)
    index_info = []
    current = None
    for index_name, data in indices_aliases.items():
        prefix, date_int, serial_int = parse_index(index_name)
        if prefix != alias:
            continue
        index_info.append((index_name, date_int, serial_int))
        info = data.get("aliases", {}).get(alias, {})
        if info.get("is_write_index"):
            current = index_name
    if not index_info:
        print(f"no indices found for alias {alias}")
        return
    index_info_sorted = sorted(index_info, key=lambda x: (x[1], x[2]))
    all_indices = [i[0] for i in index_info_sorted]
    latest = index_info_sorted[-1][0]
    if current is None:
        current = latest
    keep = {current, latest}
    delete = [i for i in all_indices if i not in keep]
    print("alias:", alias)
    print("all:", all_indices)
    print("current:", current)
    print("latest:", latest)
    print("keep:", sorted(keep))
    print("delete:", delete)
    if DRY_RUN:
        print("DRY_RUN enabled, nothing deleted")
        return
    for idx in delete:
        es.indices.delete(index=idx)
        print("deleted:", idx)

def main():
    if len(sys.argv) > 1:
        alias = sys.argv[1]
    else:
        alias = input("alias: ").strip()
    if not alias:
        print("alias required")
        return
    es = make_client()
    cleanup_alias(es, alias)

if __name__ == "__main__":
    main()
